<!DOCTYPE html>
<html lang="mn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ê–Ω–≥–ª–∏ —Ö—ç–ª–Ω–∏–π —Ç“Ø–≤—à–∏–Ω —Ç–æ–≥—Ç–æ–æ—Ö —à–∞–ª–≥–∞–ª—Ç</title>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <header class="container">
    <div class="hero card" style="align-items:flex-start">
      <div>
        <div class="chip">üöÄ SAT Placement</div>
        <h1 style="margin:6px 0 4px">SAT —Ç“Ø–≤—à–∏–Ω —Ç–æ–≥—Ç–æ–æ—Ö —Ç–µ—Å—Ç</h1>
        <p class="muted" style="margin:0">57 —Ç–µ—Å—Ç ¬∑ 70 –º–∏–Ω—É—Ç</p>
      </div>
      <div class="pill">‚è± –•—É–≥–∞—Ü–∞–∞: 70 –º–∏–Ω—É—Ç</div>
    </div>
  </header>
  <main class="container card">
    <h2 style="font-size:1.4rem">–ï—Ä”©–Ω—Ö–∏–π –º—ç–¥—ç—ç–ª—ç–ª</h2>
    <p class="note" style="margin-top:-4px">–ë”©–≥–ª”©—Å–Ω–∏–π –¥–∞—Ä–∞–∞ —à—É—É–¥ —Ç–µ—Å—Ç —Ä“Ø“Ø —à–∏–ª–∂–∏—Ö –±–æ–ª–Ω–æ.</p>
    <form id="user-form" class="form-grid">
      <label>
        –ù—ç—Ä
        <input type="text" id="name" placeholder="–û–≤–æ–≥ –ù—ç—Ä" required />
      </label>
      <label>
        –ù–∞—Å
        <input type="number" id="age" placeholder="18" min="5" max="100" required />
      </label>
      <label>
        Email
        <input type="email" id="email" placeholder="name@example.com" required />
      </label>
      <label>
        –£—Ç–∞—Å–Ω—ã –¥—É–≥–∞–∞—Ä
        <input type="tel" id="phone" placeholder="99999999" required />
      </label>
      <div class="actions" style="justify-content:space-between">
        <span class="note">–ù—ç—Ä, Email, –£—Ç–∞—Å –∑–∞–∞–≤–∞–ª —à–∞–∞—Ä–¥–∞–Ω–∞.</span>
        <div style="display:flex;gap:8px;align-items:center">
          <button type="button" id="start-sat" class="primary">SAT —Ç“Ø–≤—à–∏–Ω —Ç–æ–≥—Ç–æ–æ—Ö</button>
        </div>
      </div>
    </form>
    <p class="note">–ú—ç–¥—ç—ç–ª—ç–ª –¥—É—Ç—É—É –±–æ–ª –±–∞—Ä—É—É–Ω –¥–æ–æ—Ä –∞–Ω—Ö–∞–∞—Ä—É—É–ª–≥–∞ –≥–∞—Ä–Ω–∞.</p>
  </main>

  <div id="toast" class="toast"></div>
  <script src="/js/index.js" defer></script>

  <script>
    const PDFDocument = require('pdfkit');

    // “Æ—Ä –¥“Ø–Ω–≥–∏–π–Ω PDF “Ø“Ø—Å–≥—ç—Ö
    async function buildResultPdf(user, test) {
      return new Promise((resolve) => {
        const doc = new PDFDocument({ size: 'A4', margin: 50 });
        const chunks = [];
        doc.on('data', d => chunks.push(d));
        doc.on('end', () => resolve(Buffer.concat(chunks)));

        doc.fontSize(20).text('Exam Result', { align: 'center' }).moveDown();
        doc.fontSize(14).text(`Name: ${user.name}`);
        doc.text(`Email: ${user.email}`);
        doc.text(`Exam: ${(test.exam_type || 'Placement').toUpperCase()}`);
        doc.text(`Score: ${test.score}/30`);
        doc.text(`Level: ${test.level}`);
        doc.text(`Date: ${new Date(test.createdAt).toLocaleString()}`);

        if ((test.exam_type || '').toLowerCase() === 'sat') {
          doc.moveDown().fontSize(12).text(
            'Note: Official SAT materials are not distributed. This PDF contains only your result and general guidance.'
          );
        }
        doc.end();
      });
    }

    // –¢–µ—Å—Ç –¥—É—É—Å–∞—Ö –º–∞—Ä—à—Ä—É—Ç –¥—ç—ç—Ä PDF —Ö–∞–≤—Å–∞—Ä–≥–∞–∂ –∏–º—ç–π–ª —è–≤—É—É–ª–∞—Ö
    app.post('/api/tests/complete', async (req, res) => {
      const { testId, score, level } = req.body;
      const test = store.completeTest(testId, score, level);
      const user = store.getUsers().find(u => u.id === test.userId);
      res.json(test);

      try {
        const pdf = await buildResultPdf(user, test);
        await transporter.sendMail({
          to: user.email,
          from: process.env.SMTP_USER,
          subject: `${(test.exam_type || 'Placement').toUpperCase()} result`,
          text: `–°–∞–π–Ω –±–∞–π–Ω–∞, ${user.name}. –¢–∞–Ω—ã —Ç“Ø–≤—à–∏–Ω: ${level} (${score}/30).`,
          attachments: [{ filename: 'result.pdf', content: pdf }]
        });
      } catch (err) {
        console.error('Email send failed:', err);
      }
    });
  </script>
</body>
</html>
